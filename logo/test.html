<html>
<head>
<meta charset="utf-8">
<script src="data/vocabulary.js"></script>
<script src="data/abc.js"></script>
<script>
var imgArr = [];

String.prototype.norm = function(s, r) {return this.split("-").join("");}

function libShuffle(arr)
{
  var count = arr.length * 32;
  for(var i = 0; i < count; i ++)
  {
    var i1 = Math.floor(Math.random() * 10000) % arr.length;
    var i2 = Math.floor(Math.random() * 10000) % arr.length;
    var tmp = arr[i1];
    arr[i1] = arr[i2];
    arr[i2] = tmp;
  }
}

function libGetAllSyll()
{
  var arr = [];
  var tmp = [];
  for(var i = 0; i < imgArr.length; i ++)
  {
    var arr1 = imgArr[i].txt.split('-');
    if(arr1.length == 1) continue;
    for(var j = 0; j < arr1.length; j ++)
    {
      if(tmp[arr1[j]] != null) continue;
      tmp[arr1[j]] = "";
      arr.push(arr1[j]);
    }
  }
  libShuffle(arr);
  return arr;
}

function libBackGround(clr0, clr1)
{
  // Create gradient
  var grd = imgArr.ctx.createLinearGradient(0,0,cs.width,cs.height);
  grd.addColorStop(0, clr0);
  grd.addColorStop(1, clr1);

  // Fill with gradient
  imgArr.ctx.fillStyle = grd;
  imgArr.ctx.fillRect(0, 0, cs.width, cs.height);
}

function libDrawImgWithText(img, txt)
{
    var lineHeight = img.height / 5;
    imgArr.ctx.font = lineHeight + 'pt Calibri';
    var x = cs.width / 2 - img.width / 2;
    var y = cs.height / 20;
    imgArr.imgLeft = x;
    imgArr.imgTop = y;
    imgArr.ctx.drawImage(img, x, y);
    y += img.height;
    y += cs.height / 40;
    y += lineHeight;
    imgArr.ctx.fillStyle = 'darkblue';
    x = cs.width / 2 - imgArr.ctx.measureText(txt).width / 2;
    imgArr.ctx.fillText(txt, x, y);
}

function compScreen(mn, mx, update)
{
  if(update)
  {
    var op = ['<', '=', '>'];
    libShuffle(op);
    imgArr.txtArr = op;
    var eq = 0 == Math.floor(Math.random() * 10000) % 3;
    imgArr.left = mn + Math.floor(Math.random() * 10000) % (mx - mn + 1);
    imgArr.right = eq ? imgArr.left : mn + Math.floor(Math.random() * 10000) % (mx - mn + 1);
    imgArr.txt = '=';
    if(imgArr.left < imgArr.right) imgArr.txt = '<';
    if(imgArr.left > imgArr.right) imgArr.txt = '>';
    var numImgArr = [];
    for(var i = 0; i < imgArr.length; i ++) if(imgArr[i].num) numImgArr.push(imgArr[i]);
    imgArr.currImg = numImgArr[Math.floor(Math.random() * 10000) % numImgArr.length];
  }
  drawObjects = function()
  {
    var cnt = imgArr.left;
    var cx = 1;
    var cy = Math.ceil(cnt / cx);
    while(cx < (cy = Math.ceil(cnt / cx))) cx ++;
    var ww = imgArr.currImg.width / 3;
    var hh = imgArr.currImg.height / 3;
    var y = cs.height / 3 - hh * cy / 2;
    for(var cyy = 0; cyy < cy && cnt; cyy++)
    {
      var x = cs.width / 4 - ww * cx / 2;
      for(var cxx = 0; cxx < cx && cnt; cxx ++)
      {
        imgArr.ctx.drawImage(imgArr.currImg, x, y, ww, hh);
        x += ww;
        cnt --;
      }
      y += hh;
    }

    var cnt = imgArr.right;
    var cx = 1;
    var cy = Math.ceil(cnt / cx);
    while(cx < (cy = Math.ceil(cnt / cx))) cx ++;
    var y = cs.height / 3 - hh * cy / 2;
    for(var cyy = 0; cyy < cy && cnt; cyy++)
    {
      var x = cs.width / 4 - ww * cx / 2;
      var x = cs.width - cs.width / 4 - ww * cx / 2;
      for(var cxx = 0; cxx < cx && cnt; cxx ++)
      {
        imgArr.ctx.drawImage(imgArr.currImg, x, y, ww, hh);
        x += ww;
        cnt --;
      }
      y += hh;
    }
  }
  imgArr.draw = function()
  {
    imgArr.ctx.save();
    libBackGround("red", "yellow");
    imgArr.ctx.drawImage(imgArr.refresh, 0, 0);
    var hh = cs.height / 10;
    var ww = cs.width / 4 - hh / 2;
    
    var y = cs.height - hh;
    imgArr.ctx.font = hh + 'pt Calibri';
    imgArr.ctx.fillStyle = 'darkblue';
    imgArr.ctx.fillText(imgArr.txtArr[0], cs.width / 4 - hh / 2, y);
    imgArr.ctx.fillText(imgArr.txtArr[1], cs.width / 2 - hh / 2, y);
    imgArr.ctx.fillText(imgArr.txtArr[2], cs.width - cs.width / 4 - hh / 2, y);
    drawObjects();
    imgArr.ctx.restore();
  }
  imgArr.onClick = function(e)
  {
    var rc = cs.getBoundingClientRect();
    var x = e.clientX - rc.left;
    var y = e.clientY - rc.top;
    if(x < imgArr.refresh.width && y < imgArr.refresh.height) return compScreen(mn, mx, true);
    var hh = cs.height / 10;
    var ww = cs.width / 4;
    if(y < cs.height - 3 * hh) return;
    var vx = ww / 2;
    if(x < vx) {return};
    vx += ww;
    if(x < vx) {return imgArr.txtArr[0] == imgArr.txt ? compYesScreen() : compNoScreen(imgArr.txtArr[0]);}
    vx += ww;
    if(x < vx) {return imgArr.txtArr[1] == imgArr.txt ? compYesScreen() : compNoScreen(imgArr.txtArr[1]);}
    vx += ww;
    if(x < vx) {return imgArr.txtArr[2] == imgArr.txt ? compYesScreen() : compNoScreen(imgArr.txtArr[2]);}
    return;
  }
  compYesScreen = function()
  {
    imgArr.draw = function()
    {
      imgArr.ctx.save();
      libBackGround("red", "yellow");
      var hh = cs.height / 5;
      var x = cs.width / 2 - hh / 2;
      var y = cs.height / 3 + hh / 2;
      imgArr.ctx.font = hh + 'pt Calibri';
      imgArr.ctx.fillStyle = 'darkblue';
      imgArr.ctx.fillText(imgArr.txt, x, y);
      drawObjects();
      imgArr.ctx.restore();
    }
    imgArr.onClick = function(e) {compScreen(mn, mx, true);}
    imgArr.draw();
  }
  compNoScreen = function(sign)
  {
    imgArr.draw = function()
    {
      imgArr.ctx.save();
      libBackGround("red", "yellow");
      var hh = cs.height / 5;
      var x = cs.width / 2 - imgArr.no.width / 2;
      var y = cs.height / 2;
      imgArr.ctx.drawImage(imgArr.no, x, y - hh / 2);
//      imgArr.ctx.font = hh / 2 + 'pt Calibri';
//      imgArr.ctx.fillStyle = 'darkblue';
//      imgArr.ctx.fillText('X', x, y);
      imgArr.ctx.restore();
    }
    imgArr.onClick = function(e) {compScreen(mn, mx, false);}
    imgArr.draw();
  }
  imgArr.draw();
}

function numberScreen(update)
{
  if(update)
  {
    var numImgArr = [];
    for(var i = 0; i < imgArr.length; i ++) if(imgArr[i].num) numImgArr.push(imgArr[i]);
    while(true)
    {
      imgArr.currImg = numImgArr[Math.floor(Math.random() * 10000) % numImgArr.length];
      if(imgArr.currImg.txt.split('-').length > 1) break;
    }
    imgArr.txt = "";
    var tmp = [];
    var arr = [];
    var syllArr = imgArr.currImg.txt.split('-').concat(libGetAllSyll());
    for(var i = 0; arr.length < 7 && i < syllArr.length; i ++)
    {
      if(tmp[syllArr[i]] != null) continue;
      tmp[syllArr[i]] = "";
      arr.push(syllArr[i]);
    }
    libShuffle(arr);
    imgArr.currTxtArr = arr;
  }
  imgArr.draw = function()
  {
    imgArr.ctx.save();
    libBackGround("red", "yellow");
    libDrawImgWithText(imgArr.currImg, imgArr.txt);
    var lineHeight = cs.width / imgArr.currTxtArr.join("").length / 2;
    imgArr.ctx.font = lineHeight + 'pt Calibri';
    var y = cs.height - cs.height / 20;
    var step = cs.width - imgArr.ctx.measureText(imgArr.currTxtArr.join()).width;
    step /= (2 * imgArr.currTxtArr.length);
    var x = 0;
    imgArr.txtGrid = [];
    for(var i = 0; i < imgArr.currTxtArr.length; i ++)
    {
      var width = imgArr.ctx.measureText(imgArr.currTxtArr[i]).width;
      x += step;
      imgArr.txtGrid[i] = {"x":x,"y":y - lineHeight - cs.height / 20,"w":width};
      imgArr.ctx.fillText(imgArr.currTxtArr[i], x, y);
      x += width;
      x += step;
    }
    imgArr.ctx.restore();
  }
  imgArr.onClick = function(e)
  {
    var rc = cs.getBoundingClientRect();
    var x = e.clientX - rc.left;
    var y = e.clientY - rc.top;
    if(y < imgArr.imgTop + imgArr.currImg.height) {return numberScreen(true);}
    for(var i = 0; i < imgArr.txtGrid.length; i ++)
    {
      var s = imgArr.txtGrid[i];
      if((x >= s.x) && (x <= s.x + s.w) && (y >= s.y))
      {
        var syll = imgArr.currTxtArr[i];
        imgArr.txt += syll;
        if(imgArr.txt === imgArr.currImg.txt.norm()) return yesScreen(numberScreen);
        if(imgArr.currImg.txt.norm().indexOf(imgArr.txt) != 0) {imgArr.txt = ""; return noScreen(numberScreen);}
      }
    }
    imgArr.draw();
  }
  imgArr.draw();
}

function syllableScreen(update)
{
  if(update)
  {
    while(true)
    {
      imgArr.currImg = imgArr[Math.floor(Math.random() * 10000) % imgArr.length];
      if(imgArr.currImg.txt.split('-').length > 1) break;
    }
    imgArr.txt = "";
    var tmp = [];
    var arr = [];
    var syllArr = imgArr.currImg.txt.split('-').concat(libGetAllSyll());
    for(var i = 0; arr.length < 7 && i < syllArr.length; i ++)
    {
      if(tmp[syllArr[i]] != null) continue;
      tmp[syllArr[i]] = "";
      arr.push(syllArr[i]);
    }
    libShuffle(arr);
    imgArr.currTxtArr = arr;
  }
  imgArr.draw = function()
  {
    imgArr.ctx.save();
    libBackGround("red", "yellow");
    libDrawImgWithText(imgArr.currImg, imgArr.txt);
    var lineHeight = cs.width / imgArr.currTxtArr.join("").length / 2;
    imgArr.ctx.font = lineHeight + 'pt Calibri';
    var y = cs.height - cs.height / 20;
    var step = cs.width - imgArr.ctx.measureText(imgArr.currTxtArr.join()).width;
    step /= (2 * imgArr.currTxtArr.length);
    var x = 0;
    imgArr.txtGrid = [];
    for(var i = 0; i < imgArr.currTxtArr.length; i ++)
    {
      var width = imgArr.ctx.measureText(imgArr.currTxtArr[i]).width;
      x += step;
      imgArr.txtGrid[i] = {"x":x,"y":y - lineHeight - cs.height / 20,"w":width};
      imgArr.ctx.fillText(imgArr.currTxtArr[i], x, y);
      x += width;
      x += step;
    }
    imgArr.ctx.restore();
  }
  imgArr.onClick = function(e)
  {
    var rc = cs.getBoundingClientRect();
    var x = e.clientX - rc.left;
    var y = e.clientY - rc.top;
    if(y < imgArr.imgTop + imgArr.currImg.height) {return syllableScreen(true);}
    for(var i = 0; i < imgArr.txtGrid.length; i ++)
    {
      var s = imgArr.txtGrid[i];
      if((x >= s.x) && (x <= s.x + s.w) && (y >= s.y))
      {
        var syll = imgArr.currTxtArr[i];
        imgArr.txt += syll;
        if(imgArr.txt === imgArr.currImg.txt.norm()) return yesScreen(syllableScreen);
        if(imgArr.currImg.txt.norm().indexOf(imgArr.txt) != 0) {imgArr.txt = ""; return noScreen(syllableScreen);}
      }
    }
    imgArr.draw();
  }
  imgArr.draw();
}

function letterScreen(update)
{
  if(update)
  {
    imgArr.currImg = imgArr[Math.floor(Math.random() * 10000) % imgArr.length];
    imgArr.txt = "";
    var tmp = [];
    var arr = [];
    var txt = imgArr.currImg.txt.norm();
    for(var i = 0; i < txt.length; i ++)
    {
      var ch = txt.charAt(i);
      if(ch == "ո" && txt.charAt(i + 1) == "ւ") {ch = "ու"; i ++;}
      else if(ch == "Ո" && txt.charAt(i + 1) == "Ւ") {ch = "ՈՒ"; i ++;}
      if(ch === ch.toUpperCase())
      {
        if(tmp[ch.toLowerCase()] == null)
        {
          tmp[ch.toLowerCase()] = "";
          arr.push(ch.toLowerCase());
        }
      }
      if(tmp[ch] != null) continue;
      tmp[ch] = "";
      arr.push(ch);
    }
    var count = arr.length * 2;
    if(count < 7) count = 7;
    var i = arr.length;
    while(arr.length < count)
    {
      var ch = g_abc[Math.floor(Math.random() * 10000) % g_abc.length];
      if(tmp[ch] != null) continue;
      tmp[ch] = "";
      arr.push(ch);
    }
    libShuffle(arr);
    imgArr.currTxtArr = arr;
  }
  imgArr.draw = function()
  {
    imgArr.ctx.save();
    libBackGround("red", "yellow");
    libDrawImgWithText(imgArr.currImg, imgArr.txt);
    var lineHeight = cs.width / imgArr.currTxtArr.length / 2;
    imgArr.ctx.font = lineHeight + 'pt Calibri';
    var y = cs.height - cs.height / 20;
    var x = 0;
    for(var i = 0; i < imgArr.currTxtArr.length; i ++)
    {
      imgArr.ctx.fillText(imgArr.currTxtArr[i], x + lineHeight - imgArr.ctx.measureText(imgArr.currTxtArr[i]).width / 2, y);
      x += 2 * lineHeight;
    }
    imgArr.ctx.restore();
  }
  imgArr.onClick = function(e)
  {
    var rc = cs.getBoundingClientRect();
    var x = e.clientX - rc.left;
    var y = e.clientY - rc.top;
    if(y < imgArr.imgTop + imgArr.currImg.height) {return letterScreen(true);}
    var lineHeight = cs.width / imgArr.currTxtArr.length / 2;
    if(y < cs.height - cs.height / 10 - lineHeight) return;
    var ch = imgArr.currTxtArr[Math.floor(x / (2 * lineHeight))];
    imgArr.txt += ch;
    if(imgArr.txt === imgArr.currImg.txt.norm()) return yesScreen(letterScreen);
    if(imgArr.currImg.txt.norm().indexOf(imgArr.txt) != 0) {imgArr.txt = ""; return noScreen(letterScreen);}
    imgArr.draw();
  }
  imgArr.draw();
}

function wordScreen(update)
{
  if(update)
  {
    imgArr.currImg = imgArr[Math.floor(Math.random() * 10000) % imgArr.length];
    var tmp = [];
    var arr = [];
    var cnt = 1;
    var txt = imgArr.currImg.txt.norm();
    tmp[txt] = "";
    arr.push(txt);
    while(cnt < 3)
    {
      var txt = imgArr[Math.floor(Math.random() * 10000) % imgArr.length].txt.norm();
      if(tmp[txt] != null) continue;
      tmp[txt] = "";
      arr.push(txt);
      cnt ++;
    }
    libShuffle(arr);
    imgArr.currTxtArr = arr;
  }
  imgArr.draw = function()
  {
    imgArr.ctx.save();
    libBackGround("red", "yellow");
    var img = imgArr.currImg;
    var txtWidth = 0;
    var lineHeight = img.height / 3 - 10;
    imgArr.ctx.font = lineHeight + 'pt Calibri';

    for(var i = 0; i < imgArr.currTxtArr.length; i ++) txtWidth += imgArr.ctx.measureText(imgArr.currTxtArr[i]).width;
    if(txtWidth > cs.width - img.width)
    {
      lineHeight *= (cs.width - img.width);
      lineHeight /= txtWidth;
      imgArr.ctx.font = lineHeight + 'pt Calibri';
      txtWidth = 0;
      for(var j = 0; j < imgArr.currTxtArr.length; j ++) txtWidth += imgArr.ctx.measureText(imgArr.currTxtArr[j]).width;
    }
    var x = cs.width / 2 - (img.width + txtWidth) / 2;
    var y = cs.height / 2 - img.height / 2;
    imgArr.imgLeft = x;
    imgArr.imgTop = y;
    imgArr.ctx.drawImage(img, x, y);
    x += img.width;
    y += lineHeight;
    imgArr.ctx.fillStyle = 'darkblue';
    imgArr.txtGrid = [];
    for(var i = 0; i < imgArr.currTxtArr.length; i ++)
    {
      var txt = imgArr.currTxtArr[i];
      imgArr.ctx.fillText(txt, x, y);
      w = imgArr.ctx.measureText(txt).width;
      imgArr.txtGrid[i] = {"x":x,"y":y,"w":w};
      x += w;
      y += (lineHeight + 10);
    }
    imgArr.ctx.restore();
  }
  imgArr.onClick = function(e)
  {
    var rc = cs.getBoundingClientRect();
    var x = e.clientX - rc.left;
    var y = e.clientY - rc.top;
    if(x < imgArr.imgLeft) return;
    if(y < imgArr.imgTop) return;
    if(y > imgArr.imgTop + imgArr.currImg.height) return;
    if(x < imgArr.txtGrid[0].x)
    {
      wordScreen(true);
      imgArr.draw();
      return;
    }
    //in text
    var selTxt = "";
    if(x < imgArr.txtGrid[1].x) selTxt = imgArr.currTxtArr[0];
    else if(x < imgArr.txtGrid[2].x) selTxt = imgArr.currTxtArr[1];
    else selTxt = imgArr.currTxtArr[2];
    selTxt == imgArr.currImg.txt.norm() ? yesScreen(wordScreen) : noScreen(wordScreen);
  }
  imgArr.draw();
}

function yesScreen(retFunc)
{
  imgArr.draw = function()
  {
    imgArr.ctx.save();
    libBackGround("red", "yellow");
    var img = imgArr.currImg;
    var lineHeight = 20;
    var txt = img.txt.norm();
    imgArr.ctx.font = lineHeight + 'pt Calibri';
    var txtWidth = imgArr.ctx.measureText(txt).width;
    lineHeight *= img.width;
    lineHeight /= txtWidth;
    imgArr.ctx.font = lineHeight + 'pt Calibri';
    var x = cs.width / 2 - img.width / 2;
    var y = cs.height / 2 - img.height / 2 - (lineHeight + 10) / 2;
    imgArr.ctx.drawImage(img, x, y);
    imgArr.ctx.fillStyle = 'darkblue';
    imgArr.ctx.fillText(txt, x, y + img.height + lineHeight + 10);
    imgArr.ctx.restore();
  }
  imgArr.onClick = function(e) {retFunc(true);}
  imgArr.draw();
}

function noScreen(retFunc)
{
  imgArr.draw = function()
  {
    imgArr.ctx.save();
    libBackGround("red", "yellow");
    var img = imgArr.currImg;
    var x = cs.width / 2 - img.width / 2;
    var y = cs.height / 2 - img.height / 2;
    imgArr.ctx.drawImage(img, x, y);
    var img = imgArr.no;
    var x = cs.width / 2 - img.width / 2;
    var y = cs.height / 2 - img.height / 2;
    imgArr.ctx.drawImage(img, x, y);
    imgArr.ctx.restore();
  }
  imgArr.onClick = function(e) {retFunc(false);}
  imgArr.draw();
}

function loadingScreen()
{
  imgArr.draw = function()
  {
    imgArr.ctx.save();
    libBackGround("green", "yellow");
    imgArr.ctx.font = 20 + 'pt Calibri';
    var txt = "Նկարները բեռնվում են․․․";
    var txtWidth = imgArr.ctx.measureText(txt).width;
    var x = cs.width / 2 - txtWidth / 2;
    var y = cs.height / 2;
    imgArr.ctx.fillStyle = 'darkblue';
    imgArr.ctx.fillText(txt, x, y);
    imgArr.ctx.restore();
  }
  imgArr.draw();
}

function test0() {document.title = "Բառեր"; wordScreen(true);}
function test1() {document.title = "Տառեր"; letterScreen(true);}
function test2() {document.title = "Վանկեր"; syllableScreen(true);}
function test3() {document.title = "Թվեր"; numberScreen(true);}
function compare(mn, mx) {document.title = "Մեծ֊փոքր"; compScreen(mn, mx, true);}

window.onload = function()
{
  cs.width = cs.parentNode.clientWidth - 30;
  cs.height = cs.parentNode.clientHeight - 30;
  imgArr.ctx = cs.getContext("2d");
  loadingScreen();
  imgArr.no = new Image();
  imgArr.no.src = "img/no-small.png";
  imgArr.refresh = new Image();
  imgArr.refresh.src = "img/refresh_32.png";
  for(var i = 0; i < g_vocab.length; i ++)
  {
    var img = new Image();
    img.txt = g_vocab[i].t;
    img.num = g_vocab[i].n;
    img.src = "img/"+g_vocab[i].p;
    img.onload = function(e)
    {
      imgArr.push(e.target);
      if(imgArr.length == g_vocab.length) {window.onhashchange();}
    }
  }
  cs.addEventListener("click", function(e) {imgArr.onClick(e);})
}

window.onhashchange = function()
{
  var entryPoint = document.URL.split("#")[1];
  if(entryPoint == undefined) entryPoint = "wordScreen(true);";
  try{eval(entryPoint);}catch(e){test0();}
}

window.onresize = function()
{
  cs.width = cs.parentNode.clientWidth - 30;
  cs.height = cs.parentNode.clientHeight - 30;
  imgArr.draw();
}

</script>
<head>

<body>
<canvas id="cs" style="border:1px solid #000000"">
Ձեր ծրագիրը շատ հին է, օգտագործեք Google Crome կամ Mozila Firefox
</canvas>
</body>
</html>

