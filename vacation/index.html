<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="mobile-web-app-capable" content="yes">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="icon" href="vacation.png">
<title>Արձակուրդ</title>
</head>
<body>
<img src="vacation.png"><br>
<pre id="id_start">
Սկզբի տարեթիվը՝ <select id='id_start_y'></select>
Սկզբի ամիսը՝ <select id='id_start_m'></select>
Սկզբնական մնացորդը՝ <select id='id_start_d' ></select>
Հաշվարկման տարիները՝ <select id='id_c'></select>
</pre>
<hr>

<pre id="id_main"></pre>

<script>
const m_name = [
    "Հունվար",
    "Փետրվար",
    "Մարտ",
    "Ապրիլ",
    "Մայիս",
    "Հունիս",
    "Հուլիս",
    "Օգոստոս",
    "Սեպտեմբեր",
    "Հոկտեմբեր",
    "Նոյեմբեր",
    "Դեկտեմբեր"
];

const d_name = [
    "Կիրակի",
    "Երկուշաբթի",
    "Երեքշաբթի",
    "Չորեքշաբթի",
    "Հինգշաբթի",
    "Ուրբաթ",
    "Շաբաթ",
];

id_start_y.onchange = id_start_m.onchange = id_start_d.onchange = id_c.onchange = function() {
    window.location.href = "#" + id_start_y.value + "#" + id_start_m.value + "#" + id_start_d.value + "#" + id_c.value;
}

id_main.calc =  function(x) {
    id_start.hidden = false;
    var m = parseInt(x.start.m);
    var d = parseInt(x.start.d);
    var y_start = parseInt(x.start.y);
    var y_end = y_start + parseInt(x.c);
    var v = x.vacation;
    res = "Արձակուրդի մնացորդը / օրերը\n\n";
    for(var y = y_start; y < y_end; y ++, m = 0) {
        for(; m < 12; m ++, d += 20/12) {
            var ss = "";
            var dd = v[y] && v[y][m];
            if(undefined != dd && 0 != dd.length) {
                ss = "/ ";
                d -= dd.length;
                for(var i in dd)
                    ss += dd[i] + " ";

            }
            res += "<a href=#" + y + "#" + m + ">-- " + y + " " + m_name[m] + " " + Math.round(d) + " " + ss + "</a>\n";
        }
    }
    this.innerHTML = res;
}

id_main.edit = function(x, y, m) {
    id_start.hidden = true;
    var innerHTML = "";
    var dt = new Date(y, parseInt(m) + 1, 0);
    var day_count = dt.getDate();

    for(var d = 1; day_count > 0; d ++, day_count --) {
        dt.setDate(d);
        if(0 == dt.getDay() || 6 == dt.getDay())
            continue;
        var chk = "";
        try {
            for(dd in x.vacation[y][m])
                if(x.vacation[y][m][dd] == d)
                    chk ="checked";
        }
        catch(e) {}

        innerHTML += "<input type='checkbox' " + chk + " value='" + d + "'>" + d + " " + m_name[m] + " " + y + " ( " + d_name[dt.getDay()] + " )</input>\n";
    }
    this.innerHTML = innerHTML;
}

id_main.save = function(x, y, m) {
    id_start.hidden = false;
    if(undefined == x.vacation[y])
        x.vacation[y] = {};
    x.vacation[y][m] = [];
    var chk_arr = id_main.getElementsByTagName("input");
    for(i in chk_arr) {
        if(chk_arr[i].checked)
            x.vacation[y][m].push(chk_arr[i].value);
    }
    if(0 == x.vacation[y][m].length)
        delete x.vacation[y][m];
    if(0 == Object.keys(x.vacation[y]).length)
        delete x.vacation[y];
    localStorage.x = JSON.stringify(x);
}

id_start_y.init = function(init_value) {
    var innerHTML = "";
    for(var i = 0; i < 4; i ++)
        innerHTML += "<option value=" + (2020 + i) + ">" + (2020 + i) + "</option>\n";
    this.innerHTML = innerHTML;
    this.value = init_value;
}

id_start_m.init = function(init_value) {
    var innerHTML = "";
    for(var i = 0; i < m_name.length; i ++)
        innerHTML += "<option value=" + i + ">" + m_name[i] + "</option>\n";
    this.innerHTML = innerHTML;
    this.value = init_value;
}

id_start_d.init = function(init_value) {
    var innerHTML = "";
    for(var i = 0; i < 31; i ++)
        innerHTML += "<option value=" + i + ">" + i + "</option>\n";
    this.innerHTML = innerHTML;
    this.value = init_value;
}

id_c.init = function(init_value) {
    var innerHTML = "";
    for(var i = 1; i < 5; i ++)
        innerHTML += "<option value=" + i + ">" + i + "</option>\n";
    this.innerHTML = innerHTML;
    this.value = init_value;
}

window.onhashchange = function(evt) {
    var x = load();
    try {
        var args = evt.newURL.split("#");
        if(args[1] < 2020 || args[1] > 2023 || args[2] < 0 || args[2] > m_name.length - 1)
            throw "Out of range year/month";
        if(5 == args.length) {
            id_start_y.value = x.start.y = args[1];
            id_start_m.value = x.start.m = args[2];
            id_start_d.value = x.start.d = args[3];
            if(args[4] < 1 || args[4] > 4)
                throw "Out of range number or years to show";
            id_c.value = x.c = args[4];

            var save_args = evt.oldURL.split("#");
            if(save_args[1] < 2020 || save_args[1] > 2023 || save_args[2] < 0 || save_args[2] > m_name.length - 1)
                throw "Out of range year/month";

            if(3 == save_args.length) {
                id_main.save(x, save_args[1], save_args[2]);
            }
            id_main.calc(x);
            return;
        }
        if(3 == args.length) {
            id_main.edit(x, args[1], args[2]);
            return;
        }
    }
    catch(e) {
        console.log(e);
    }
}

function load() {
    if(undefined == localStorage.x)
        localStorage.x = '{"start":{"y":"2020","m":"10","d":"16"},"c":"2","vacation":{}}';

    return JSON.parse(localStorage.x);
}

(function() {
    var x = load();
    id_start_y.init(x.start.y);
    id_start_m.init(x.start.m);
    id_start_d.init(x.start.d);
    id_c.init(x.c);
    window.location.href = "#" + id_start_y.value + "#" + id_start_m.value + "#" + id_start_d.value + "#" + id_c.value;
    id_main.calc(x);
}());

</script>
</body>
</html>
